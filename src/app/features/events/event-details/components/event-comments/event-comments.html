<section class="container-app mt-6 pb-10">
  <section class="card p-5 sm:p-6">
    <div class="flex items-center justify-between gap-3">
      <h2 class="text-lg font-bold">Comments</h2>
      <span class="text-sm" style="color: rgb(var(--muted))">
        @if(!loading()) { {{ comments().length }} }
      </span>
    </div>

    @if (loading()) {
    <p class="mt-4" style="color: rgb(var(--muted))">Loading comments…</p>
    } @else {

    <!-- Add comment -->
    @if (userId()) {
    <div class="mt-4">
      <label class="block text-sm font-medium mb-2">Add a comment</label>

      <textarea
        class="details-textarea"
        [ngModel]="newCommentText()"
        (ngModelChange)="newCommentText.set($event)"
        placeholder="Write a comment…"
        rows="3"
      ></textarea>

      <div class="mt-3 flex items-center justify-between gap-3">
        <p class="text-xs" style="color: rgb(var(--muted))">Be respectful. Staff can moderate.</p>

        <button
          type="button"
          class="btn btn-primary"
          (click)="addComment()"
          [disabled]="submitting() || !newCommentText().trim()"
        >
          @if (submitting()) { Adding… } @else { Add comment }
        </button>
      </div>
    </div>
    } @else {
    <div class="mt-4">
      <p class="text-sm" style="color: rgb(var(--muted))">Log in to add a comment.</p>
    </div>
    }

    <!-- List -->
    @if (comments().length === 0) {
    <div class="mt-6">
      <p class="text-sm" style="color: rgb(var(--muted))">No comments yet.</p>
    </div>
    } @else {
    <ul class="mt-6 space-y-3">
      @for (c of comments(); track c._id) {
      <li class="comment-card" [class.is-deleted]="c.isDeleted">
        <div class="comment-head">
          <div class="min-w-0">
            <p class="comment-author">{{ c.user?.email || 'Unknown user' }}</p>

            <p class="comment-date">
              {{ formatCommentDate(c.createdAt) }}
              @if (c.isDeleted && c.deletedAt) {
              <span class="opacity-70">• {{ formatCommentDate(c.deletedAt) }}</span>
              }
            </p>
          </div>

          <button
            type="button"
            class="btn btn-ghost comment-like"
            (click)="toggleLike(c._id)"
            [class.is-liked]="c.likedByCurrentUser"
          >
            ♥ {{ c.likesCount }}
          </button>
        </div>

        @if (c.isDeleted) {
        <p class="comment-deleted-text">This comment is deleted.</p>
        } @else {
        <p class="comment-text">{{ c.text }}</p>
        }

        <!-- Actions -->
        @if (canDeleteComment(c) || isStaff()) {
        <div class="comment-actions">
          @if (!c.isDeleted && canDeleteComment(c)) { @if (editingCommentId() === c._id) {
          <textarea
            class="details-textarea mt-2"
            [value]="editText()"
            (input)="editText.set($any($event.target).value)"
            rows="3"
          ></textarea>

          <div class="mt-3 flex gap-2">
            <button type="button" class="btn btn-primary" (click)="saveEdit(c._id)">Save</button>
            <button type="button" class="btn btn-ghost" (click)="cancelEdit()">Cancel</button>
          </div>
          } @else {
          <div class="mt-3 flex flex-wrap gap-2">
            <button type="button" class="btn btn-ghost" (click)="startEdit(c)">Edit</button>
            <button
              type="button"
              class="btn btn-ghost btn-danger-soft"
              (click)="openDeleteConfirm(c)"
            >
              Delete
            </button>
          </div>
          } } @if (c.isDeleted && canDeleteComment(c)) {
          <div class="mt-3">
            <button type="button" class="btn btn-ghost" (click)="restoreComment(c)">Restore</button>
          </div>
          } @if (isStaff()) {
          <div class="mt-3">
            <button type="button" class="btn btn-ghost" (click)="openHistory(c._id)">
              History
            </button>
          </div>
          }
        </div>
        }
      </li>
      }
    </ul>
    }

    <!-- Confirm delete modal -->
    @if (confirmOpen()) {
    <div class="confirm-backdrop" (click)="cancelDelete()">
      <div class="confirm-dialog" (click)="$event.stopPropagation()">
        <h3>Delete comment</h3>
        <p>This will hide the comment for users. You can restore it later.</p>

        <div class="confirm-actions">
          <button type="button" class="btn-cancel" (click)="cancelDelete()">Cancel</button>
          <button type="button" class="btn-delete" (click)="confirmDelete()">Delete</button>
        </div>
      </div>
    </div>
    }

    <!-- History modal (staff) -->
    @if (historyOpen()) {
    <div class="modal-backdrop" (click)="closeHistory()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3 class="modal-title">Comment history</h3>
          <button type="button" class="btn btn-ghost modal-x" (click)="closeHistory()">×</button>
        </div>

        <div class="modal-body">
          @if (historyLoading()) {
          <p style="color: rgb(var(--muted))">Loading…</p>
          } @else if (commentHistory().length === 0) {
          <p style="color: rgb(var(--muted))">No history.</p>
          } @else {
          <ul class="history-mini">
            @for (h of commentHistory(); track $index) {
            <li>
              <strong>{{ h.action }}</strong> – {{ formatCommentDate(h.createdAt) }} @if
              (h.userId?.email) { <span> by {{ h.userId.email }}</span> }
            </li>
            }
          </ul>
          }
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-ghost" (click)="closeHistory()">Close</button>
        </div>
      </div>
    </div>
    } }
  </section>
</section>
